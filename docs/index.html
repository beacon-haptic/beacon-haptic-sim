<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>店舗案内システム</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="css/Proc_style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
  <header>
    <link rel="stylesheet" href="css/Proc_style.css">
    <h1 class="site-title"></h1>
    <button id="menu-toggle" class="hamburger">☰</button>
    <nav id="sidebar" class="sidebar">
     <ul>
      <li><a href="itirann.html">商品一覧</a></li>
      <li><a href="#">メニュー2</a></li>
      <li><a href="#">メニュー3</a></li>
     </ul>
    </nav>

    <button onclick="showContent()" id="show-search-button">🔍</button>
  <div id="search-panel">
    <div id="hidden-content">
      <label for="search"></label>
      <input type="text" id="search" name="q" placeholder="キーワードを入力">
      <button type="button" onclick="showbackContent()" id="show-back-button">×</button>
    </div>
    <div id="search-results" class="container mt-4 row"></div>
  </div>
  

  </header>




  <main>
      <link rel="stylesheet" href="css/Proc_style.css">
      <img id="img" src="picture/map_open.png" alt="画像1">
  </main>


<script src="../kuromoji.js-master/kuromoji.js-master/build/kuromoji.js"></script>




  <script>
    ///以下検索項目の表示非表示の切り替え

    //検索ボタンを押した時、検索項目と戻るボタンの表示・元々あった検索ボタンの非表示
    function showContent() {
      document.getElementById('hidden-content').style.display = 'flex';
      document.getElementById('show-search-button').style.display = 'none';
      document.getElementById('show-back-button').style.display = 'block';
      document.getElementById('search-panel').classList.add('active');
      document.getElementById('search').focus();
      const showButton = document.getElementById('show-search-button');
    }
    //戻るボタンを押した時、検索項目と戻るボタンの非表示・元々あった検索ボタンの表示
    function showbackContent() {
      document.getElementById('hidden-content').style.display = 'none';
      document.getElementById('show-search-button').style.display = 'block';
      document.getElementById('show-back-button').style.display = 'none';
      document.getElementById('search-panel').classList.remove('active');
      document.getElementById('search-results').innerHTML = "";
      document.getElementById('search').value = "";

      const showButton = document.getElementById('show-back-button');
    }
      document.getElementById('menu-toggle').addEventListener('click', function () {
        const sidebar = document.getElementById('sidebar');
        const toggleButton = document.getElementById('menu-toggle');

        sidebar.classList.toggle('active');
        toggleButton.classList.toggle('no-border');
      });
  </script>

<!-- Firebase互換版の読み込み -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
  // Firebase設定
  const firebaseConfig = {
    apiKey: "AIzaSyAHiMCeiOFN-R4EoLTiBpeJWIUQYIrUA5M",
    authDomain: "beacon-haptic-sim.firebaseapp.com",
    projectId: "beacon-haptic-sim",
    storageBucket: "beacon-haptic-sim.appspot.com",
    messagingSenderId: "699174750938",
    appId: "1:699174750938:web:1ade40d8ef1a30c9c0b3e3",
    measurementId: "G-4QX9T79SL7"
  };

  // Firebase初期化
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  function expandWithSynonyms(words) {
  const expandedSet = new Set();

  words.forEach(word => {
    expandedSet.add(word);
    if (synonymDictionary[word]) {
      synonymDictionary[word].forEach(syn => expandedSet.add(syn));
    }
  });

  return Array.from(expandedSet);
  }


  let synonymDictionary = {};  // 類義語辞書（グローバル）

  async function buildSynonymDictionaryFromFirebase() {
  const snapshot = await db.collection("products").get();
  const tagMap = {};

  snapshot.forEach(doc => {
    const tags = doc.data().tags || [];

    tags.forEach(tag => {
      if (!tagMap[tag]) tagMap[tag] = new Set();
      tags.forEach(otherTag => {
        if (tag !== otherTag) {
          tagMap[tag].add(otherTag);
        }
      });
    });
  });

  // Set → Array に変換
  for (const tag in tagMap) {
    synonymDictionary[tag] = Array.from(tagMap[tag]);
  }

  console.log("📚 類義語辞書生成完了:", synonymDictionary);
}

 buildSynonymDictionaryFromFirebase(); // 実行


  // フォーム送信防止（不要かもしれませんが）
  document.getElementById('hidden-content').addEventListener('submit', (event) => {
    event.preventDefault();
  });

  // kuromojiトークナイザーを用意
  let tokenizer = null; // ← グローバルに宣言

  kuromoji.builder({ dicPath: "../kuromoji.js-master/kuromoji.js-master/dict" }).build(function (err, builtTokenizer) {
    if (err) {
    console.error("kuromoji読み込みエラー:", err);
    return;
  }
    tokenizer = builtTokenizer; // ← グローバル変数に代入
    const path = tokenizer.tokenize("すもももももももものうち");
    console.log(path);
  });


  // デバウンス用タイマー
  let debounceTimer;

  document.getElementById('search').addEventListener('input', function(event) {
    const keyword = event.target.value.trim();

    clearTimeout(debounceTimer);

    debounceTimer = setTimeout(() => {
      if(keyword === "") {
        document.getElementById('search-results').innerHTML = "";
        return;
      }

      if(!tokenizer) {
        // tokenizerがまだ準備できてなければ処理しない
        return;
      }

      // kuromojiで形態素解析
      const tokens = tokenizer.tokenize(keyword);
      let words = tokens.map(token => token.surface_form.toLowerCase());

      words = expandWithSynonyms(words); // 追加

      searchItems(words);

      }, 300);
  });

  async function searchItems(words) {
    const resultsContainer = document.getElementById('search-results');
    resultsContainer.innerHTML = "";

    const snapshot = await db.collection("products").get();

    let matchedItems = [];

 snapshot.forEach(doc => {
  const data = doc.data();

  // 各項目を個別に小文字化
  const name = (data.name || "").toLowerCase();
  const category = (data.category || "").toLowerCase();
  const detail = (data.detail || "").toLowerCase();
  const tags = (data.tags || []).join(" ").toLowerCase();

  const fullText = `${name} ${category} ${detail} ${tags}`;

  // 少なくとも1単語が一致しているか確認
  const matched = words.some(w => fullText.includes(w));
  if (!matched) return;

  // スコア付け（nameに含まれている単語が多いほどスコア高く）
  let score = 0;
  words.forEach(w => {
    if (name.includes(w)) score += 10;
    if (category.includes(w)) score += 3;
    if (detail.includes(w)) score += 1;
    if (tags.includes(w)) score += 2;
  });

  matchedItems.push({ doc, data, score });
 });

// スコアで降順ソート
  matchedItems.sort((a, b) => b.score - a.score);

  // 表示
    if (matchedItems.length === 0) {
      resultsContainer.innerHTML = `<p>該当する商品が見つかりませんでした。</p>`;
    }   else {
      matchedItems.forEach(({ doc, data }) => {
        resultsContainer.innerHTML += `
          <div class="search-item">
            <a href="detail.html?id=${doc.id}" style="text-decoration:none; color:inherit;">
              <h5 class="item-name">${data.name}</h5>
              <p class="item-category">${data.category}</p>
            </a>
          </div>
        `;
      });
    }
  }
</script>


</body>
</html>