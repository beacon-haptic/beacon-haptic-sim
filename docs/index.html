<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>åº—èˆ—æ¡ˆå†…ã‚·ã‚¹ãƒ†ãƒ </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="css/Proc_style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
  <header>
    <h1>åº—èˆ—æ¡ˆå†…ã‚·ã‚¹ãƒ†ãƒ </h1>
    <button id="menu-toggle" class="hamburger">â˜°</button>
    <nav id="sidebar" class="sidebar">
     <ul>
      <li><a href="itirann.html">å•†å“ä¸€è¦§</a></li>
      <li><a href="#">ãƒ¡ãƒ‹ãƒ¥ãƒ¼2</a></li>
      <li><a href="#">ãƒ¡ãƒ‹ãƒ¥ãƒ¼3</a></li>
     </ul>
    </nav>
  </header>

      <button onclick="showContent()" id="show-search-button">ğŸ”</button>
  <div id="search-panel">
    <div id="hidden-content">
      <label for="search"></label>
      <input type="text" id="search" name="q" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      <button type="button" onclick="showbackContent()" id="show-back-button">Ã—</button>
    </div>
    <div id="search-results" class="container mt-4 row"></div>
  </div>



  <main>
      <link rel="stylesheet" href="css/Proc_style.css">
      <img id="img" src="picture/åº—èˆ—map.png" alt="ç”»åƒ1">
  </main>
</body>
  <script>
    ///ä»¥ä¸‹æ¤œç´¢é …ç›®ã®è¡¨ç¤ºéè¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ

    //æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã€æ¤œç´¢é …ç›®ã¨æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºãƒ»å…ƒã€…ã‚ã£ãŸæ¤œç´¢ãƒœã‚¿ãƒ³ã®éè¡¨ç¤º
    function showContent() {
      document.getElementById('hidden-content').style.display = 'flex'; // OK
      document.getElementById('show-search-button').style.visibility = 'hidden'; // â† display â†’ visibility
      document.getElementById('show-back-button').style.display = 'block';
      document.getElementById('search-panel').classList.add('active');
      document.getElementById('search').focus();
    }

    function showbackContent() {
      document.getElementById('hidden-content').style.display = 'none';
      document.getElementById('show-search-button').style.visibility = 'visible'; // â† display â†’ visibility
      document.getElementById('show-back-button').style.display = 'none';
      document.getElementById('search-panel').classList.remove('active');
      document.getElementById('search-results').innerHTML = "";
      document.getElementById('search').value = "";
    

      const showButton = document.getElementById('show-back-button');
    }
      document.getElementById('menu-toggle').addEventListener('click', function () {
        const sidebar = document.getElementById('sidebar');
        const toggleButton = document.getElementById('menu-toggle');

        sidebar.classList.toggle('active');
        toggleButton.classList.toggle('no-border');
      });
  </script>

<script src="kuromoji.js-master/kuromoji.js-master/build/kuromoji.js"></script>

<!-- Firebaseäº’æ›ç‰ˆã®èª­ã¿è¾¼ã¿ -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
  // Firebaseè¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyAHiMCeiOFN-R4EoLTiBpeJWIUQYIrUA5M",
    authDomain: "beacon-haptic-sim.firebaseapp.com",
    projectId: "beacon-haptic-sim",
    storageBucket: "beacon-haptic-sim.appspot.com",
    messagingSenderId: "699174750938",
    appId: "1:699174750938:web:1ade40d8ef1a30c9c0b3e3",
    measurementId: "G-4QX9T79SL7"
  };

  // FirebaseåˆæœŸåŒ–
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  function expandWithSynonyms(words) {
  const expandedSet = new Set();

  words.forEach(word => {
    expandedSet.add(word);
    if (synonymDictionary[word]) {
      synonymDictionary[word].forEach(syn => expandedSet.add(syn));
    }
  });

  return Array.from(expandedSet);
  }


  let synonymDictionary = {};  // é¡ç¾©èªè¾æ›¸ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰

  async function buildSynonymDictionaryFromFirebase() {
  const snapshot = await db.collection("products").get();
  const tagMap = {};

  snapshot.forEach(doc => {
    const tags = doc.data().tags || [];

    tags.forEach(tag => {
      if (!tagMap[tag]) tagMap[tag] = new Set();
      tags.forEach(otherTag => {
        if (tag !== otherTag) {
          tagMap[tag].add(otherTag);
        }
      });
    });
  });

  // Set â†’ Array ã«å¤‰æ›
  for (const tag in tagMap) {
    synonymDictionary[tag] = Array.from(tagMap[tag]);
  }

  console.log("ğŸ“š é¡ç¾©èªè¾æ›¸ç”Ÿæˆå®Œäº†:", synonymDictionary);
}

 buildSynonymDictionaryFromFirebase(); // å®Ÿè¡Œ


  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡é˜²æ­¢ï¼ˆä¸è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒï¼‰
  document.getElementById('hidden-content').addEventListener('submit', (event) => {
    event.preventDefault();
  });

  // kuromojiãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚’ç”¨æ„
  let tokenizer = null; // â† ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®£è¨€

  kuromoji.builder({ dicPath: "../kuromoji.js-master/kuromoji.js-master/dict" }).build(function (err, builtTokenizer) {
    if (err) {
    console.error("kuromojièª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
    return;
  }
    tokenizer = builtTokenizer; // â† ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä»£å…¥
    const path = tokenizer.tokenize("ã™ã‚‚ã‚‚ã‚‚ã‚‚ã‚‚ã‚‚ã‚‚ã‚‚ã®ã†ã¡");
    console.log(path);
  });


  // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ç”¨ã‚¿ã‚¤ãƒãƒ¼
  let debounceTimer;

  document.getElementById('search').addEventListener('input', function(event) {
    const keyword = event.target.value.trim();

    clearTimeout(debounceTimer);

    debounceTimer = setTimeout(() => {
      if(keyword === "") {
        document.getElementById('search-results').innerHTML = "";
        return;
      }

      if(!tokenizer) {
        // tokenizerãŒã¾ã æº–å‚™ã§ãã¦ãªã‘ã‚Œã°å‡¦ç†ã—ãªã„
        return;
      }

      // kuromojiã§å½¢æ…‹ç´ è§£æ
      const tokens = tokenizer.tokenize(keyword);
      let words = tokens.map(token => token.surface_form.toLowerCase());

      words = expandWithSynonyms(words); // è¿½åŠ 

      searchItems(words);

      }, 300);
  });

  async function searchItems(words) {
    const resultsContainer = document.getElementById('search-results');
    resultsContainer.innerHTML = "";

    const snapshot = await db.collection("products").get();

    let matchedItems = [];

 snapshot.forEach(doc => {
  const data = doc.data();

  // å„é …ç›®ã‚’å€‹åˆ¥ã«å°æ–‡å­—åŒ–
  const name = (data.name || "").toLowerCase();
  const category = (data.category || "").toLowerCase();
  const detail = (data.detail || "").toLowerCase();
  const tags = (data.tags || []).join(" ").toLowerCase();

  const fullText = `${name} ${category} ${detail} ${tags}`;

  // å°‘ãªãã¨ã‚‚1å˜èªãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèª
  const matched = words.some(w => fullText.includes(w));
  if (!matched) return;

  // ã‚¹ã‚³ã‚¢ä»˜ã‘ï¼ˆnameã«å«ã¾ã‚Œã¦ã„ã‚‹å˜èªãŒå¤šã„ã»ã©ã‚¹ã‚³ã‚¢é«˜ãï¼‰
  let score = 0;
  words.forEach(w => {
    if (name.includes(w)) score += 10;
    if (category.includes(w)) score += 3;
    if (detail.includes(w)) score += 1;
    if (tags.includes(w)) score += 2;
  });

  matchedItems.push({ doc, data, score });
 });

// ã‚¹ã‚³ã‚¢ã§é™é †ã‚½ãƒ¼ãƒˆ
  matchedItems.sort((a, b) => b.score - a.score);

  // è¡¨ç¤º
    if (matchedItems.length === 0) {
      resultsContainer.innerHTML = `<p>è©²å½“ã™ã‚‹å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
    }   else {
      matchedItems.forEach(({ doc, data }) => {
        resultsContainer.innerHTML += `
          <div class="search-item">
            <a href="detail.html?id=${doc.id}" style="text-decoration:none; color:inherit;">
              <h5 class="item-name">${data.name}</h5>
              <p class="item-category">${data.category}</p>
            </a>
          </div>
        `;
      });
    }
  }
</script>
</html>
