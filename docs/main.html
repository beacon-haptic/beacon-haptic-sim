<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="maximum-scale=1.0, user-scalable=no">
<title>åº—èˆ—æ¡ˆå†…ã‚·ã‚¹ãƒ†ãƒ </title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="css/Proc_style.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="kuromoji.js-master/kuromoji.js-master/build/kuromoji.js"></script>
</head>
<body>

<header>
  <h1>
    åº—èˆ—æ¡ˆå†…ã‚·ã‚¹ãƒ†ãƒ 
    <button id="logout-btn" class="btn btn-sm btn-danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </h1>
  <nav class="category-nav">
    <a href="index.html" class="active">ãƒ›ãƒ¼ãƒ </a>
    <a href="itirann.html">å•†å“ä¸€è¦§</a>
    <a href="favorite.html">ãŠæ°—ã«å…¥ã‚Š</a>
  </nav>
</header>

<button onclick="showContent()" id="show-search-button">ğŸ”</button>
<div id="search-panel">
  <div id="hidden-content">
    <input type="text" id="search" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
    <button type="button" onclick="showbackContent()" id="show-back-button">Ã—</button>
  </div>
  <div id="search-results" class="container mt-4 row"></div>
</div>

<main>
  <div id="map"></div>
  <div id="bottom-image">
    <div class="image-wrapper">
      <div class="image-text">åº—èˆ—å…¨ä½“å›³</div>
      <img src="picture/æ•™å®¤ãƒãƒƒãƒ—ï¼’.jpg" alt="ãƒãƒƒãƒ—ä¸‹ã®ç”»åƒ" />
    </div>
  </div>
</main>

<!-- æ¤œç´¢ãƒ‘ãƒãƒ«åˆ‡æ›¿ -->
<script>
function showContent() {
  document.getElementById('hidden-content').style.display = 'flex';
  document.getElementById('show-search-button').style.visibility = 'hidden';
  document.getElementById('show-back-button').style.display = 'block';
  document.getElementById('search-panel').classList.add('active');
  document.getElementById('search').focus();
}
function showbackContent() {
  document.getElementById('hidden-content').style.display = 'none';
  document.getElementById('show-search-button').style.visibility = 'visible';
  document.getElementById('show-back-button').style.display = 'none';
  document.getElementById('search-panel').classList.remove('active');
  document.getElementById('search-results').innerHTML = "";
  document.getElementById('search').value = "";
}
</script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAiHMCeiOFN-R4EoLTiBpeJWlUQYIrUA5M",
  authDomain: "beacon-haptic-sim.firebaseapp.com",
  projectId: "beacon-haptic-sim",
  storageBucket: "beacon-haptic-sim.appspot.com",
  messagingSenderId: "699174750938",
  appId: "1:699174750938:web:1ade40d8ef1a30c9c0b3e3",
  measurementId: "G-4QX9T79SL7"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

auth.onAuthStateChanged(user => {
  const logoutBtn = document.getElementById('logout-btn');
  if (!user) location.href = "index.html";
  if (user.isAnonymous) {
    logoutBtn.textContent = "ãƒ­ã‚°ã‚¤ãƒ³";
    logoutBtn.classList.replace("btn-danger","btn-secondary");
    logoutBtn.onclick = () => location.href = "index.html";
  } else {
    logoutBtn.textContent = "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ";
    logoutBtn.onclick = async () => {
      try { await auth.signOut(); location.href = "index.html"; }
      catch(e) { alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¤±æ•—: "+e.message); }
    };
  }
});
</script>

<script>
/* =======================
   Kuromojiæ¤œç´¢
======================= */
let tokenizer = null;

kuromoji.builder({ dicPath: "../kuromoji.js-master/kuromoji.js-master/dict" })
.build((err,builtTokenizer)=>{
  if(err){ console.error(err); return; }
  tokenizer = builtTokenizer;
  initSearch();
});

function normalizeText(t){
  if(!t) return "";
  return t.normalize("NFKC").toLowerCase()
          .replace(/[ã-ã‚“]/g,s=>String.fromCharCode(s.charCodeAt(0)+0x60));
}
function tokenizeText(text){
  if(!tokenizer) return [];
  const n = normalizeText(text);
  return tokenizer.tokenize(n).map(t=>normalizeText(t.surface_form));
}

// tokenizer æº–å‚™å®Œäº†å¾Œã«æ¤œç´¢ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
function initSearch(){
  const input = document.getElementById('search');
  let debounceTimer;
  input.addEventListener('input', e=>{
    const keyword = e.target.value.trim();
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(()=>{
      if(!keyword || !tokenizer){
        document.getElementById('search-results').innerHTML="";
        return;
      }
      searchItems(tokenizeText(keyword));
    },300);
  });
}

async function searchItems(words){
  const resultsContainer = document.getElementById('search-results');
  resultsContainer.innerHTML="";
  const snapshot = await db.collection("products").get();
  let matchedItems=[];
  snapshot.forEach(doc=>{
    const data = doc.data();
    const allWords = [
      ...tokenizeText(data.name||""),
      ...tokenizeText(data.category||""),
      ...tokenizeText(data.detail||""),
      ...tokenizeText((data.tags||[]).join(" "))
    ];
    if(!words.every(w=>allWords.includes(w))) return;

    let score=0;
    words.forEach(w=>{
      if(tokenizeText(data.name||[]).includes(w)) score+=10;
      if(tokenizeText(data.category||[]).includes(w)) score+=3;
      if(tokenizeText(data.detail||[]).includes(w)) score+=1;
      if(tokenizeText((data.tags||[]).join(" ")).includes(w)) score+=2;
    });
    matchedItems.push({doc,data,score});
  });

  matchedItems.sort((a,b)=>b.score-a.score);
  if(matchedItems.length===0){
    resultsContainer.innerHTML="<p>è©²å½“ã™ã‚‹å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
  }else{
    matchedItems.forEach(({doc,data})=>{
      resultsContainer.innerHTML += `
      <div class="search-item">
        <a href="detail.html?id=${doc.id}"  style="text-decoration:none;color:inherit;">
          <h5>${data.name}</h5>
          <p>${data.category}</p>
        </a>
      </div>`;
    });
  }
}
</script>

<script>
/* =======================
   Leafletãƒãƒƒãƒ—è¨­å®š
======================= */
const originalW=2000, originalH=1500;
const scale = window.innerWidth>=992?0.3:0.5;
const w=originalW*scale, h=originalH*scale;
const bounds=[[0,0],[h,w]];

const map = L.map('map',{crs:L.CRS.Simple, minZoom:-2,maxZoom:2, zoomSnap:0.25, zoomDelta:0.25, zoomControl:false});
L.imageOverlay('picture/æ•™å®¤ãƒãƒƒãƒ—ï¼‘.jpg', bounds).addTo(map);
const initialCenter=[h/2,w/2], initialZoom=-0.25;
map.setView(initialCenter,initialZoom);

// ã‚ºãƒ¼ãƒ ãƒ»ãƒªã‚»ãƒƒãƒˆ
const ZoomResetControl = L.Control.extend({
  options:{position:'topleft'},
  onAdd:function(map){
    const c=L.DomUtil.create('div','leaflet-control-zoom leaflet-bar');
    const zin=L.DomUtil.create('a','leaflet-control-zoom-in',c);
    zin.innerHTML='+'; zin.href='#'; zin.onclick=e=>{e.preventDefault(); map.zoomIn();};
    const zout=L.DomUtil.create('a','leaflet-control-zoom-out',c);
    zout.innerHTML='-'; zout.href='#'; zout.onclick=e=>{e.preventDefault(); map.zoomOut();};
    const reset=L.DomUtil.create('a','leaflet-control-reset',c);
    reset.innerHTML='&#x21BA;'; reset.href='#'; reset.style.fontSize='32px';
    reset.onclick=e=>{e.preventDefault(); map.setView(initialCenter,initialZoom);};
    return c;
  }
});
map.addControl(new ZoomResetControl());

// ç¾åœ¨ä½ç½® & å•†å“ãƒŠãƒ“
let userPos=null;
let userMarker=null;
let routeLine=null;

function mapCoord(x,y){ return [y*scale,x*scale]; }

function updateUserPosition(x,y){
  userPos = mapCoord(x,y);
  if(userMarker) map.removeLayer(userMarker);
  userMarker = L.circleMarker(userPos,{radius:8,color:'blue',fillColor:'deepskyblue',fillOpacity:0.9}).addTo(map);
}
// =======================
// ç¾åœ¨ä½ç½®æ›´æ–°ï¼ˆãƒ“ãƒ¼ã‚³ãƒ³ä¸‰è§’æ¸¬é‡ï¼‰
// =======================

// ä¸‰è§’æ¸¬é‡ï¼ˆãƒˆãƒªãƒ©ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰é–¢æ•°
function trilateration(beacons) {
  // beacons = [{x, y, distance}, ...] 3ç‚¹
  const [b1, b2, b3] = beacons;

  const A = 2*(b2.x - b1.x);
  const B = 2*(b2.y - b1.y);
  const C = b1.distance**2 - b2.distance**2 - b1.x**2 + b2.x**2 - b1.y**2 + b2.y**2;
  const D = 2*(b3.x - b2.x);
  const E = 2*(b3.y - b2.y);
  const F = b2.distance**2 - b3.distance**2 - b2.x**2 + b3.x**2 - b2.y**2 + b3.y**2;

  const x = (C*E - F*B) / (E*A - B*D);
  const y = (C*D - A*F) / (B*D - A*E);
  return {x, y};
}

const beacons=[
  {id:"1",x:268,y:188},
  {id:"2",x:490,y:1088},
  {id:"3",x:1846,y:1044}
];

// ãƒ“ãƒ¼ã‚³ãƒ³è·é›¢ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½ç½®ã‚’æ›´æ–°
function updateUserWithBeacons(beaconDistances) {
  // beaconDistances = [{id:"1", distance:100}, ...]
  const beaconsData = beacons.map(b => {
    const d = beaconDistances.find(bd => bd.id === b.id);
    return {x:b.x, y:b.y, distance:d.distance};
  });

  const user = trilateration(beaconsData);
  updateUserPosition(user.x, user.y);
}

updateUserPosition(1121, 226);

// ãƒ“ãƒ¼ã‚³ãƒ³è·é›¢ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆä¾‹ï¼‰
const beaconDistances = [
  {id:"1", distance:100},
  {id:"2", distance:200},
  {id:"3", distance:150}
];

// ä¸‰è§’æ¸¬é‡ã§ç¾åœ¨ä½ç½®ã‚’æ›´æ–°
updateUserWithBeacons(beaconDistances);





// å•†å“ãƒŠãƒ“
window.navigateToProduct = async function(id){
  const doc = await db.collection("products").doc(id).get();
  if(!doc.exists){ alert("å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
  const d = doc.data();
  if(!d.x || !d.y){ alert("å•†å“ã«åº§æ¨™ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
  const target = mapCoord(d.x,d.y);
  if(!userPos){ alert("ç¾åœ¨ä½ç½®ã‚’å–å¾—ã§ãã¾ã›ã‚“"); return; }
  if(routeLine) map.removeLayer(routeLine);
  routeLine = L.polyline([userPos,target],{color:'red',weight:4}).addTo(map);
  map.fitBounds([userPos,target],{padding:[40,40],
  maxZoom: initialZoom +0.2,
  animate: true,              
  duration: 0.5 });
};

// ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯ã§åº§æ¨™ç¢ºèª
map.on("click", e=>{
  alert(`x=${e.latlng.lng/scale}, y=${e.latlng.lat/scale}`);
});

beacons.forEach(b=>{
  L.circleMarker(mapCoord(b.x,b.y),{radius:10,color:'green',fillColor:'lime',fillOpacity:0.9})
    .bindTooltip(`Beacon ${b.id}<br>(x:${b.x},y:${b.y})`,{permanent:true,direction:"top",offset:[0,-10]})
    .addTo(map);
});

// Firestoreã®user_positions/currentã‚’ç›£è¦–ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
db.collection("user_positions").doc("current")
  .onSnapshot(doc => {
    if (!doc.exists) return;
    const data = doc.data();

    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ãƒ“ãƒ¼ã‚³ãƒ³è·é›¢ã‚’ä½œã‚‹
    const beaconDistances = beacons.map(b => {
      return { id: b.id, distance: data[b.id] || null };
    }).filter(b => b.distance !== null);

    if (beaconDistances.length >= 3) {
      updateUserWithBeacons(beaconDistances);
    }
  });


  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ targetId ã‚’å–å¾—
const params = new URLSearchParams(window.location.search);
const targetId = params.get("targetId");

if(targetId){
  // navigateToProducté–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ãƒŠãƒ“é–‹å§‹
  window.navigateToProduct(targetId);
}


</script>

</body>
</html>
