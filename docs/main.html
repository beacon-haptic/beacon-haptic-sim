<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0, user-scalable=no">
    <title>åº—èˆ—æ¡ˆå†…ã‚·ã‚¹ãƒ†ãƒ </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/Proc_style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <header>
    <h1>
      åº—èˆ—æ¡ˆå†…ã‚·ã‚¹ãƒ†ãƒ 
      <span id="user-email" style="margin-left:10px; font-size:16px; color:#555;"></span>
      <button id="logout-btn" class="btn btn-sm btn-danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </h1>
    <nav class="category-nav">
      <a href="index.html" class="active">ãƒ›ãƒ¼ãƒ </a>
      <a href="itirann.html">å•†å“ä¸€è¦§</a>
      <a href="favorite.html">ãŠæ°—ã«å…¥ã‚Š</a>
    </nav>
  </header>

  <button onclick="showContent()" id="show-search-button">ğŸ”</button>
  <div id="search-panel">
    <div id="hidden-content">
      <label for="search"></label>
      <input type="text" id="search" name="q" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      <button type="button" onclick="showbackContent()" id="show-back-button">Ã—</button>
    </div>
    <div id="search-results" class="container mt-4 row"></div>
  </div>

  <main>
    <div id="map"></div>
    <div id="bottom-image">
      <div class="image-wrapper">
        <div class="image-text">åº—èˆ—å…¨ä½“å›³</div>
        <img src="picture/åº—èˆ—ãƒãƒƒãƒ—ï¼’.jpg" alt="ãƒãƒƒãƒ—ä¸‹ã®ç”»åƒ" />
      </div>
    </div>
  </main>

  <!-- æ¤œç´¢ãƒ‘ãƒãƒ«åˆ‡æ›¿ -->
  <script>
    function showContent() {
      document.getElementById('hidden-content').style.display = 'flex';
      document.getElementById('show-search-button').style.visibility = 'hidden';
      document.getElementById('show-back-button').style.display = 'block';
      document.getElementById('search-panel').classList.add('active');
      document.getElementById('search').focus();
    }

    function showbackContent() {
      document.getElementById('hidden-content').style.display = 'none';
      document.getElementById('show-search-button').style.visibility = 'visible';
      document.getElementById('show-back-button').style.display = 'none';
      document.getElementById('search-panel').classList.remove('active');
      document.getElementById('search-results').innerHTML = "";
      document.getElementById('search').value = "";
    }
  </script>

  <!-- Kuromoji -->
  <script src="kuromoji.js-master/kuromoji.js-master/build/kuromoji.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyAiHMCeiOFN-R4EoLTiBpeJWlUQYIrUA5M",
      authDomain: "beacon-haptic-sim.firebaseapp.com",
      projectId: "beacon-haptic-sim",
      storageBucket: "beacon-haptic-sim.appspot.com",
      messagingSenderId: "699174750938",
      appId: "1:699174750938:web:1ade40d8ef1a30c9c0b3e3",
      measurementId: "G-4QX9T79SL7"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth(); // â† Firebase Auth
    const db = firebase.firestore();

    auth.onAuthStateChanged(user => {
      if (!user) {
        // æœªãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸å¼·åˆ¶ç§»å‹•
        location.href = "index.html";
      } else {
        // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ â†’ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹è¡¨ç¤º
        const emailSpan = document.getElementById('user-email');
        if(emailSpan) {
          emailSpan.textContent = user.email;
        }
      }
    });

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³
    window.addEventListener('DOMContentLoaded', () => {
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            await auth.signOut();        // Firebaseã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ
            location.href = "index.html"; // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸é·ç§»
          } catch (e) {
            alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
          }
        });
      }
    });

    // æ­£è¦åŒ–ãƒ»ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚º
    function normalizeText(text) {
      if (!text) return "";
      return text
        .normalize("NFKC")
        .toLowerCase()
        .replace(/[ã-ã‚“]/g, s => String.fromCharCode(s.charCodeAt(0) + 0x60));
    }

    let tokenizer = null;
    function tokenizeText(text) {
      if (!tokenizer) return [];
      const normalized = normalizeText(text);
      return tokenizer.tokenize(normalized).map(t => normalizeText(t.surface_form));
    }

    kuromoji.builder({ dicPath: "../kuromoji.js-master/kuromoji.js-master/dict" }).build((err, builtTokenizer) => {
      if (err) { console.error(err); return; }
      tokenizer = builtTokenizer;
    });

    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹æ¤œç´¢
    let debounceTimer;
    document.getElementById('search').addEventListener('input', function(event) {
      const keyword = event.target.value.trim();
      clearTimeout(debounceTimer);

      debounceTimer = setTimeout(() => {
        if(keyword === "" || !tokenizer) {
          document.getElementById('search-results').innerHTML = "";
          return;
        }

        const words = tokenizeText(keyword);
        searchItems(words);
      }, 300);
    });

    // æ¤œç´¢å‡¦ç†
    async function searchItems(words) {
      const resultsContainer = document.getElementById('search-results');
      resultsContainer.innerHTML = "";

      const snapshot = await db.collection("products").get();
      let matchedItems = [];

      snapshot.forEach(doc => {
        const data = doc.data();
        const allWords = [
          ...tokenizeText(data.name || ""),
          ...tokenizeText(data.category || ""),
          ...tokenizeText(data.detail || ""),
          ...tokenizeText((data.tags || []).join(" "))
        ];

        if(!words.every(w => allWords.includes(w))) return;

        let score = 0;
        words.forEach(w => {
          if (tokenizeText(data.name || "").includes(w)) score += 10;
          if (tokenizeText(data.category || "").includes(w)) score += 3;
          if (tokenizeText(data.detail || "").includes(w)) score += 1;
          if (tokenizeText((data.tags || []).join(" ")).includes(w)) score += 2;
        });

        matchedItems.push({ doc, data, score });
      });

      matchedItems.sort((a,b) => b.score - a.score);

      if(matchedItems.length === 0){
        resultsContainer.innerHTML = `<p>è©²å½“ã™ã‚‹å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
      } else {
        matchedItems.forEach(({ doc, data }) => {
          resultsContainer.innerHTML += `
            <div class="search-item">
              <a href="detail.html?id=${doc.id}" style="text-decoration:none; color:inherit;">
                <h5 class="item-name">${data.name}</h5>
                <p class="item-category">${data.category}</p>
              </a>
            </div>
          `;
        });
      }
    }
  </script>

  <!-- Leaflet ãƒãƒƒãƒ— -->
  <script>
    const originalW = 2000;
    const originalH = 1500;
    let scale = window.innerWidth >= 992 ? 0.3 : 0.5;
    const w = originalW * scale;
    const h = originalH * scale;
    const bounds = [[0,0],[h,w]];

    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 2,
      zoom: 0,
      zoomControl: false,
      zoomSnap: 0.25,
      zoomDelta: 0.25
    });

    L.imageOverlay('picture/åº—èˆ—ãƒãƒƒãƒ—ï¼‘.jpg', bounds).addTo(map);
    const initialCenter = [h/2, w/2];
    const initialZoom = -0.25;
    map.setView(initialCenter, initialZoom);

    // ã‚ºãƒ¼ãƒ ï¼‹ãƒªã‚»ãƒƒãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
    const ZoomResetControl = L.Control.extend({
      options: { position: 'topleft' },
      onAdd: function(map) {
        const container = L.DomUtil.create('div', 'leaflet-control-zoom leaflet-bar');

        const zoomIn = L.DomUtil.create('a','leaflet-control-zoom-in',container);
        zoomIn.innerHTML = '+';
        zoomIn.href='#';
        zoomIn.onclick = e => { e.preventDefault(); map.zoomIn(); }

        const zoomOut = L.DomUtil.create('a','leaflet-control-zoom-out',container);
        zoomOut.innerHTML = '-';
        zoomOut.href='#';
        zoomOut.onclick = e => { e.preventDefault(); map.zoomOut(); }

        const resetBtn = L.DomUtil.create('a','leaflet-control-reset',container);
        resetBtn.innerHTML = '&#x21BA;';
        resetBtn.href='#';
        resetBtn.style.fontSize = '32px';
        resetBtn.style.lineHeight = '38px';
        resetBtn.onclick = e => { e.preventDefault(); map.setView(initialCenter, initialZoom); }

        return container;
      }
    });
    map.addControl(new ZoomResetControl());
  </script>

</body>
</html>
