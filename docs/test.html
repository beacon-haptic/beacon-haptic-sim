<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>åº—èˆ—æ¡ˆå†…ã‚·ã‚¹ãƒ†ãƒ </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/Proc_test_style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <header>
    <h1>åº—èˆ—æ¡ˆå†…ã‚·ã‚¹ãƒ†ãƒ </h1>
    <nav class="category-nav">
      <a href="index.html" class="active">ãƒ›ãƒ¼ãƒ </a>
      <a href="itirann_test.html">å•†å“ä¸€è¦§</a>
      <a href="#">ãŠæ°—ã«å…¥ã‚Š</a>
    </nav>
  </header>

  <button onclick="showContent()" id="show-search-button">ğŸ”</button>
  <div id="search-panel">
    <div id="hidden-content">
      <label for="search"></label>
      <input type="text" id="search" name="q" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      <button type="button" onclick="showbackContent()" id="show-back-button">Ã—</button>
    </div>
    <div id="search-results" class="container mt-4 row"></div>
  </div>

  <main>
    <div id="map"></div>
  </main>

  <script>
    // æ¤œç´¢ãƒ‘ãƒãƒ«è¡¨ç¤ºåˆ‡æ›¿
    function showContent() {
      document.getElementById('hidden-content').style.display = 'flex';
      document.getElementById('show-search-button').style.visibility = 'hidden';
      document.getElementById('show-back-button').style.display = 'block';
      document.getElementById('search-panel').classList.add('active');
      document.getElementById('search').focus();
    }

    function showbackContent() {
      document.getElementById('hidden-content').style.display = 'none';
      document.getElementById('show-search-button').style.visibility = 'visible';
      document.getElementById('show-back-button').style.display = 'none';
      document.getElementById('search-panel').classList.remove('active');
      document.getElementById('search-results').innerHTML = "";
      document.getElementById('search').value = "";
    }
  </script>

  <script src="kuromoji.js-master/kuromoji.js-master/build/kuromoji.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyAHiMCeiOFN-R4EoLTiBpeJWIUQYIrUA5M",
      authDomain: "beacon-haptic-sim.firebaseapp.com",
      projectId: "beacon-haptic-sim",
      storageBucket: "beacon-haptic-sim.appspot.com",
      messagingSenderId: "699174750938",
      appId: "1:699174750938:web:1ade40d8ef1a30c9c0b3e3",
      measurementId: "G-4QX9T79SL7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- æ­£è¦åŒ–é–¢æ•° ---
    function normalizeText(text) {
      if (!text) return "";
      return text
        .normalize("NFKC")
        .toLowerCase()
        .replace(/[ã-ã‚“]/g, s =>
          String.fromCharCode(s.charCodeAt(0) + 0x60)
        );
    }

    // --- ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚ºé–¢æ•° ---
    let tokenizer = null;
    function tokenizeText(text) {
      if (!tokenizer) return [];
      const normalized = normalizeText(text);
      return tokenizer.tokenize(normalized).map(t => normalizeText(t.surface_form));
    }

    kuromoji.builder({ dicPath: "../kuromoji.js-master/kuromoji.js-master/dict" }).build((err, builtTokenizer) => {
      if (err) { console.error(err); return; }
      tokenizer = builtTokenizer;
    });

    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹æ¤œç´¢
    let debounceTimer;
    document.getElementById('search').addEventListener('input', function(event) {
      const keyword = event.target.value.trim();
      clearTimeout(debounceTimer);

      debounceTimer = setTimeout(() => {
        if(keyword === "" || !tokenizer) {
          document.getElementById('search-results').innerHTML = "";
          return;
        }

        const words = tokenizeText(keyword); // é¡ç¾©èªãªã—
        searchItems(words);
      }, 300);
    });

    // æ¤œç´¢å‡¦ç†
    async function searchItems(words) {
      const resultsContainer = document.getElementById('search-results');
      resultsContainer.innerHTML = "";

      const snapshot = await db.collection("products").get();
      let matchedItems = [];

      snapshot.forEach(doc => {
        const data = doc.data();
        const allWords = [
          ...tokenizeText(data.name || ""),
          ...tokenizeText(data.category || ""),
          ...tokenizeText(data.detail || ""),
          ...tokenizeText((data.tags || []).join(" "))
        ];

        if(!words.some(w => allWords.includes(w))) return;

        let score = 0;
        words.forEach(w => {
          if (tokenizeText(data.name || "").includes(w)) score += 10;
          if (tokenizeText(data.category || "").includes(w)) score += 3;
          if (tokenizeText(data.detail || "").includes(w)) score += 1;
          if (tokenizeText((data.tags || []).join(" ")).includes(w)) score += 2;
        });

        matchedItems.push({ doc, data, score });
      });

      matchedItems.sort((a,b) => b.score - a.score);

      if(matchedItems.length === 0){
        resultsContainer.innerHTML = `<p>è©²å½“ã™ã‚‹å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
      } else {
        matchedItems.forEach(({ doc, data }) => {
          resultsContainer.innerHTML += `
            <div class="search-item">
              <a href="detail_test.html?id=${doc.id}" style="text-decoration:none; color:inherit;">
                <h5 class="item-name">${data.name}</h5>
                <p class="item-category">${data.category}</p>
              </a>
            </div>
          `;
        });
      }
    }
  </script>

  <script>
  const w = 2000;
  const h = 1500;

  // bounds ã‚’å¤§ããã™ã‚‹ã¨ç”»åƒã¯ç¸®å°ã•ã‚Œã€ç”»é¢ã«åã¾ã‚‹
  const bounds = [[0, 0], [h/2, w/2]];  // æ•°å€¤ã‚’å¾®èª¿æ•´

  const map = L.map('map', {
    crs: L.CRS.Simple,
    minZoom: -2,
    maxZoom: 2,
    zoom: 0,
    zoomControl: false

  });

  // ImageOverlay ã‚’è¿½åŠ 
  L.imageOverlay('picture/åº—èˆ—ãƒãƒƒãƒ—.jpg', bounds).addTo(map);

  const initialCenter = window.innerWidth < 768 ? [h/6, w/4] : [h/4, w/4];
  const initialZoom = 0;

  // åˆæœŸä½ç½®è¨­å®š
  map.setView(initialCenter, initialZoom);

  // fitBounds ã‚’ä½¿ã†ã¨è‡ªå‹•ã§ç¸®å°ã•ã‚Œã‚‹ã®ã§ä¸è¦
  // map.fitBounds(bounds);

  // ä»£ã‚ã‚Šã«åˆæœŸè¡¨ç¤ºã®ä¸­å¿ƒã¨ã‚ºãƒ¼ãƒ ã‚’è¨­å®š
  map.setView([h/8, w/4], 0);  // ä¸­å¤®åº§æ¨™ã‚’å¾®èª¿æ•´

  </script>

  <script>
      // ã‚ºãƒ¼ãƒ ã¨ãƒªã‚»ãƒƒãƒˆã®è¤‡åˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
    const ZoomResetControl = L.Control.extend({
      options: {
        position: 'topleft'
      },

      onAdd: function(map) {
        // æ¨™æº– zoom ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã® HTML ã‚’è‡ªåˆ†ã§ä½œã‚‹
        const container = L.DomUtil.create('div', 'leaflet-control-zoom leaflet-bar');

        // ï¼‹ãƒœã‚¿ãƒ³
        const zoomIn = L.DomUtil.create('a', 'leaflet-control-zoom-in', container);
        zoomIn.innerHTML = '+';
        zoomIn.href = '#';
        zoomIn.onclick = function(e) {
        e.preventDefault();
          map.zoomIn();
        };

        // âˆ’ãƒœã‚¿ãƒ³
        const zoomOut = L.DomUtil.create('a', 'leaflet-control-zoom-out', container);
        zoomOut.innerHTML = '-';
        zoomOut.href = '#';
        zoomOut.onclick = function(e) {
          e.preventDefault();
          map.zoomOut();
        };

        // ğŸ”„ ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ï¼ˆã‚ãªãŸã®è¿½åŠ éƒ¨åˆ†ï¼‰
        const resetBtn = L.DomUtil.create('a', 'leaflet-control-reset', container);
        resetBtn.innerHTML = '&#x21BA;';
        resetBtn.href = '#';
        resetBtn.style.fontSize = '32px';
        resetBtn.style.lineHeight = '38px';
        resetBtn.style.textAlign = 'center';

        resetBtn.onclick = function(e) {
          e.preventDefault();
          map.setView(initialCenter, initialZoom);
        };

        return container;
      }
    });

    // åœ°å›³ã«è¿½åŠ 
    map.addControl(new ZoomResetControl());


  </script>

</html>
