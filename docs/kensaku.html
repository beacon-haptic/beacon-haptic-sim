<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>åº—èˆ—æ¡ˆå†…ã‚·ã‚¹ãƒ†ãƒ </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="css/Proc_style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
  <header>
    <h1>åº—èˆ—æ¡ˆå†…ã‚·ã‚¹ãƒ†ãƒ </h1>
    <button id="menu-toggle" class="hamburger">â˜°</button>
    <nav id="sidebar" class="sidebar">
     <ul>
      <li><a href="itirann.html">å•†å“ä¸€è¦§</a></li>
      <li><a href="#">ãŠæ°—ã«å…¥ã‚Š</a></li>
      <li><a href="#">ãƒ¡ãƒ‹ãƒ¥ãƒ¼3</a></li>
     </ul>
    </nav>
  </header>

  <button onclick="showContent()" id="show-search-button">ğŸ”</button>
  <div id="search-panel">
    <div id="hidden-content">
      <label for="search"></label>
      <input type="text" id="search" name="q" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      <button type="button" onclick="showbackContent()" id="show-back-button">Ã—</button>
    </div>
    <div id="search-results" class="container mt-4 row"></div>
  </div>

  <main>
      <link rel="stylesheet" href="css/Proc_style.css">
      <img id="img" src="picture/åº—èˆ—ãƒãƒƒãƒ—.jpg" alt="ç”»åƒ1">
  </main>

  <script>
    // --- æ¤œç´¢ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºåˆ‡æ›¿ ---
    function showContent() {
      document.getElementById('hidden-content').style.display = 'flex';
      document.getElementById('show-search-button').style.visibility = 'hidden';
      document.getElementById('show-back-button').style.display = 'block';
      document.getElementById('search-panel').classList.add('active');
      document.getElementById('search').focus();
    }

    function showbackContent() {
      document.getElementById('hidden-content').style.display = 'none';
      document.getElementById('show-search-button').style.visibility = 'visible';
      document.getElementById('show-back-button').style.display = 'none';
      document.getElementById('search-panel').classList.remove('active');
      document.getElementById('search-results').innerHTML = "";
      document.getElementById('search').value = "";
    }

    document.getElementById('menu-toggle').addEventListener('click', function () {
      const sidebar = document.getElementById('sidebar');
      const toggleButton = document.getElementById('menu-toggle');
      sidebar.classList.toggle('active');
      toggleButton.classList.toggle('no-border');
    });
  </script>

  <script src="kuromoji.js-master/kuromoji.js-master/build/kuromoji.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    // --- Firebaseè¨­å®š ---
    const firebaseConfig = {
      apiKey: "AIzaSyAHiMCeiOFN-R4EoLTiBpeJWIUQYIrUA5M",
      authDomain: "beacon-haptic-sim.firebaseapp.com",
      projectId: "beacon-haptic-sim",
      storageBucket: "beacon-haptic-sim.appspot.com",
      messagingSenderId: "699174750938",
      appId: "1:699174750938:web:1ade40d8ef1a30c9c0b3e3",
      measurementId: "G-4QX9T79SL7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- æ­£è¦åŒ–é–¢æ•° ---
    function normalizeText(text) {
      if (!text) return "";
      return text
        .normalize("NFKC")
        .toLowerCase()
        .replace(/[ã-ã‚“]/g, s =>
          String.fromCharCode(s.charCodeAt(0) + 0x60)
        ); // ã²ã‚‰ãŒãªâ†’ã‚«ã‚¿ã‚«ãƒŠ
    }

    // --- æ–‡å­—åˆ—ã‚’ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚º ---
    function tokenizeText(text) {
      if (!tokenizer) return [];
      const normalized = normalizeText(text);
      return tokenizer.tokenize(normalized).map(t => normalizeText(t.surface_form));
    }

    // --- kuromojiåˆæœŸåŒ– ---
    let tokenizer = null;
    kuromoji.builder({ dicPath: "../kuromoji.js-master/kuromoji.js-master/dict" }).build(function (err, builtTokenizer) {
      if (err) { console.error("kuromojièª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err); return; }
      tokenizer = builtTokenizer;
    });

    // --- ãƒ‡ãƒã‚¦ãƒ³ã‚¹æ¤œç´¢ ---
    let debounceTimer;
    document.getElementById('search').addEventListener('input', function(event) {
      const keyword = event.target.value.trim();
      clearTimeout(debounceTimer);

      debounceTimer = setTimeout(() => {
        if(keyword === "") {
          document.getElementById('search-results').innerHTML = "";
          return;
        }

        if(!tokenizer) return;

        const words = tokenizeText(keyword); // é¡ç¾©èªå±•é–‹ãªã—
        searchItems(words);

      }, 300);
    });

    // --- æ¤œç´¢å‡¦ç† ---
    async function searchItems(words) {
      const resultsContainer = document.getElementById('search-results');
      resultsContainer.innerHTML = "";

      const snapshot = await db.collection("products").get();
      let matchedItems = [];

      snapshot.forEach(doc => {
        const data = doc.data();
        const nameWords = tokenizeText(data.name || "");
        const categoryWords = tokenizeText(data.category || "");
        const detailWords = tokenizeText(data.detail || "");
        const tagWords = tokenizeText((data.tags || []).join(" "));

        const allWords = [...nameWords, ...categoryWords, ...detailWords, ...tagWords];
        const matched = words.some(w => allWords.includes(w));
        if (!matched) return;

        let score = 0;
        let scoreDetail = { name:0, category:0, detail:0, tag:0 };

        words.forEach(w => {
          if (nameWords.includes(w)) { score += 10; scoreDetail.name += 10; }
          if (categoryWords.includes(w)) { score += 3; scoreDetail.category += 3; }
          if (detailWords.includes(w)) { score += 1; scoreDetail.detail += 1; }
          if (tagWords.includes(w)) { score += 2; scoreDetail.tag += 2; }
        });

        matchedItems.push({ doc, data, score, scoreDetail });
      });

      matchedItems.sort((a, b) => b.score - a.score);

      if (matchedItems.length === 0) {
        resultsContainer.innerHTML = `<p>è©²å½“ã™ã‚‹å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
      } else {
        matchedItems.forEach(({ doc, data, scoreDetail }) => {
          resultsContainer.innerHTML += `
            <div class="search-item border p-2 mb-2">
              <a href="detail.html?id=${doc.id}" style="text-decoration:none; color:inherit;">
                <h5 class="item-name">${data.name}</h5>
                <p class="item-category">${data.category}</p>
              </a>
              <div class="score-detail" style="font-size:0.9em; color:#555;">
                ğŸ”¹ ã‚¹ã‚³ã‚¢å†…è¨³: name ${scoreDetail.name}, category ${scoreDetail.category}, detail ${scoreDetail.detail}, tag ${scoreDetail.tag}
              </div>
            </div>
          `;
        });
      }
    }
  </script>
</body>
</html>

