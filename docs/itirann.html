<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>商品一覧ページ</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/Proc_itirann_style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body>
    <header>
        <h1>
            商品一覧
            <button id="logout-btn" class="btn btn-sm btn-danger">ログアウト</button>
        </h1>
        <nav class="category-nav">
            <a href="main.html">ホーム</a>
            <a href="itirann.html" class="active">商品一覧</a>
            <a href="favorite.html">お気に入り</a>
        </nav>   
    </header> 
    
    <div class="back-color">
        <main class="container mt-4">
            <div id="product-list" class="row g-4">
                <!-- 商品リストがここに表示 -->
            </div>
        </main>
    </div>

    <!-- スクロールトップボタン -->
    <button id="scroll-top-btn">↑</button>

    <!-- Firebase（互換版） -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase 初期化
        const firebaseConfig = {
            apiKey: "AIzaSyAiHMCeiOFN-R4EoLTiBpeJWlUQYIrUA5M",
            authDomain: "beacon-haptic-sim.firebaseapp.com",
            projectId: "beacon-haptic-sim",
            storageBucket: "beacon-haptic-sim.appspot.com",
            messagingSenderId: "699174750938",
            appId: "1:699174750938:web:1ade40d8ef1a30c9c0b3e3",
            measurementId: "G-4QX9T79SL7"
        };
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();

        const logoutBtn = document.getElementById("logout-btn");
        const productContainer = document.getElementById("product-list");
        const scrollTopBtn = document.getElementById("scroll-top-btn");

        /* -----------------------------
           ログイン状態チェック
        ----------------------------- */
        auth.onAuthStateChanged(user => {
            if (!user) {
                location.href = "index.html";
                return;
            }

            if (user.isAnonymous) {
                logoutBtn.textContent = "ログイン";
                logoutBtn.classList.replace("btn-danger", "btn-secondary");
                logoutBtn.onclick = () => location.href = "index.html";
            } else {
                logoutBtn.textContent = "ログアウト";
                logoutBtn.classList.replace("btn-secondary", "btn-danger");
                logoutBtn.onclick = async () => {
                    try {
                        await auth.signOut();
                        location.href = "index.html";
                    } catch (e) {
                        alert("ログアウトに失敗しました: " + e.message);
                    }
                };
            }
        });

        /* -----------------------------
           Firestore 商品読み込み
        ----------------------------- */
        async function loadProducts() {
            productContainer.innerHTML = "";

            const snapshot = await db.collection("products").get();
            let products = [];

            snapshot.forEach(doc => {
                products.push({ id: doc.id, ...doc.data() });
            });

            // 五十音順
            products.sort((a, b) => a.name.localeCompare(b.name, "ja"));

            products.forEach(product => {
                const card = document.createElement("div");
                card.className = "col-md-6";

                card.innerHTML = `
                    <div class="product-card">
                        <div class="image-wrapper">
                            <img src="${product.imageUrl}" 
                                 alt="${product.name}" 
                                 loading="lazy">
                        </div>
                        <h5>${product.name}</h5>
                    </div>
                `;

                // クリックで詳細ページへ
                card.querySelector(".product-card").addEventListener("click", () => {
                    location.href = `detail.html?id=${product.id}`;
                });

                productContainer.appendChild(card);
            });
        }

        window.addEventListener("DOMContentLoaded", loadProducts);

        /* -----------------------------
           スクロールトップボタン
        ----------------------------- */
        window.addEventListener("scroll", () => {
            scrollTopBtn.style.display = window.scrollY > 200 ? "block" : "none";
        });

        scrollTopBtn.addEventListener("click", () => {
            window.scrollTo({ top: 0, behavior: "smooth" });
        });
    </script>
</body>
</html>
